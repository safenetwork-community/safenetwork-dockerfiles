#!/bin/bash

# turn on bash's job control
set -m

PROG_NAME=run_safenode

# Command arguments #

SHORT_OPTS=hVv
LONG_OPTS="name:,log-level:,\
skip-auto-port-forwarding:,\
con-ip:,con-port:,pub-ip:,pub-port:,\
idle-timeout-msec:,keep-alive-interval-msec:,\
log-dir:,root-dir:,first:,version,help"

# sn_node Parameters #

FIRST=false
LOG_LEVEL=error
IDLE_TIMEOUT_MSEC=4000
KEEP_ALIVE_INTERVAL_MSEC=5500
IP_NUMBER=0

# RegEx #

RE_NUMBER='^[0-9]+$'

# Safety check parameters for `safe network switch` #

APP_NAME="sn_node"
APP_COUNT=$(pgrep -x $APP_NAME | wc -l)

help()
{
  sn_node --help
  exit 2
}

version()
{
  echo "Podman run script for safenode v1.0"
  exit 2
}

usage()
{
  echo "Usage: run_safenode [ --name NETWORK_NAME ] 
    [ --log-level LOG_LEVEL ]
    [ --skip-auto-port-forwarding SKIP_AUTO_PORT_FORWARDING ]
    [ --idle-timeout-msec IDLE_TIMEOUT_MSEC ]
    [ --keep-alive-interval-msec KEEP_ALIVE_INTERVAL_MSEC ]
    [ --con-ip CON_IP ] 
    [ --con-port CON_PORT ]
    [ --pub-ip PUB_IP ]
    [ --pub-port PUB_PORT ]
    [ --log-dir LOG_DIR ]
    [ --root-dir ROOT_DIR ]
    [ --first FIRST ]"
  exit 2
}

PARSED_ARGUMENTS=$(getopt -o $SHORT_OPTS --longoptions $LONG_OPTS --name $PROG_NAME -- "$@")

VALID_ARGUMENTS=$?
if [ "$VALID_ARGUMENTS" != "0" ]; then
  usage
fi

eval set -- "$PARSED_ARGUMENTS"
while : 
do
  case "$1" in 
    --name) NETWORK_NAME="$2"; shift 2;;
    --log-level) LOG_LEVEL="$2"; shift 2;;
    --skip-auto-port-forwarding) SKIP_AUTO_PORT_FORWARDING="$2"; shift 2;;
    --idle-timeout-msec) IDLE_TIMEOUT_MSEC="$2"; shift 2;;
    --keep-alive-interval-msec) KEEP_ALIVE_INTERVAL_MSEC="$2"; shift 2;;
    --con-ip) CON_IP="$2"; shift 2;;
    --con-port) CON_PORT="$2"; shift 2;;
    --pub-ip) PUB_IP="$2"; shift 2;;
    --pub-port) PUB_PORT="$2"; shift 2;;
    --log-dir) LOG_DIR="$2"; shift 2;;
    --root-dir) ROOT_DIR="$2"; shift 2;;
    --first) FIRST="$2"; shift 2;;
    -h | --help) help ;;
    -v | --version) version ;;
    --) shift; break ;;
    *) echo "Unexpected option: $1 - this should not happen."
       usage ;;
  esac
done

case $LOG_LEVEL in
  "warn") VERBOSE_OPT=" -v";;
  "info") VERBOSE_OPT=" -vv" ;;
  "debug") VERBOSE_OPT=" -vvv" ;;
  "trace") VERBOSE_OPT=" -vvvv" ;;
esac

if [ "$SKIP_AUTO_PORT_FORWARDING" = true ]; then
  SKIP_AUTO_PORT_FORWARDING_OPT=" --skip-auto-port-forwarding"
fi

if [[ $IDLE_TIMEOUT_MSEC =~ $RE_NUMBER ]]; then
  IDLE_TIMEOUT_MSEC_OPT=" --idle-timeout-msec ${IDLE_TIMEOUT_MSEC}" 
fi

if [[ $KEEP_ALIVE_INTERVAL_MSEC =~ $RE_NUMBER ]]; then
  KEEP_ALIVE_INTERVAL_MSEC_OPT=" --keep-alive-interval-msec ${KEEP_ALIVE_INTERVAL_MSEC}" 
fi

if [ -n "$LOG_DIR" ]; then
  LOG_DIR_OPT=" --log-dir ${LOG_DIR}" 
fi

if [ -n "$ROOT_DIR" ]; then
  ROOT_DIR_OPT=" --root-dir ${ROOT_DIR}" 
fi

if [ "$CON_IP" == "con_ipv4" ]; then 
  CON_IP=$(ip -4 -o addr show up scope global | while read -r num dev fam addr rest; do echo ${addr%/*}; done | head -n 1)
elif [ "$CON_IP" == "con_ipv6" ]; then 
  CON_IP=$(ip -6 -o addr show up scope global | while read -r num dev fam addr rest; do echo ${addr%/*}; done | head -n 1)
elif [ "$CON_IP" == "local_ipv4" ]; then
   CON_IP=127.0.0.1
elif [ "$CON_IP" == "local_ipv6" ] || [ "$CON_IP" == "localhost" ]; then
   CON_IP=::1
fi

if [ "$PUB_IP" == "con_ipv4" ]; then 
  PUB_IP=$(ip -4 -o addr show up scope global | while read -r num dev fam addr rest; do echo ${addr%/*}; done | head -n 1)
elif [ "$PUB_IP" == "con_ipv6" ]; then 
  PUB_IP=$(ip -6 -o addr show up scope global | while read -r num dev fam addr rest; do echo ${addr%/*}; done | head -n 1)
fi

CON_OPT=" --local-addr ${CON_IP}:${CON_PORT}"

if [ "$CON_IP" != "127.0.0.1" ]; then 
  PUB_OPT=" --public-addr ${PUB_IP}:${PUB_PORT}"
fi

if [ "$FIRST" = true ]; then
  RUST_BACKTRACE=full COLORBT_SHOW_HIDDEN=1 sn_node\
  ${VERBOSE_OPT}${IDLE_TIMEOUT_MSEC_OPT}${KEEP_ALIVE_INTERVAL_MSEC_OPT}${SKIP_AUTO_PORT_FORWARDING_OPT}\
  ${CON_OPT}${PUB_OPT}${LOG_DIR_OPT}${ROOT_DIR_OPT} --first &
  while [ "$APP_COUNT" -eq "0" ]
  do
    sleep 1
    APP_COUNT=$(pgrep -x $APP_NAME | wc -l)
  done
  safe networks add ${NETWORK_NAME}
  safe networks switch ${NETWORK_NAME}
else
  safe networks switch ${NETWORK_NAME}
  RUST_BACKTRACE=full COLORBT_SHOW_HIDDEN=1 sn_node\
  ${VERBOSE_OPT}${IDLE_TIMEOUT_MSEC_OPT}${KEEP_ALIVE_INTERVAL_MSEC_OPT}${SKIP_AUTO_PORT_FORWARDING_OPT}\
  ${CON_OPT}${PUB_OPT}${LOG_DIR_OPT}${ROOT_DIR_OPT} &
fi

# Put the primary process into the foreground and leave it there
fg %1
