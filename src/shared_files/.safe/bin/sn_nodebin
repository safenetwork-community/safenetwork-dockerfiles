#!/bin/bash

ERROR_LOG=""
NODES_PATH=~/.safe/node
TWO_NEW_LINES=$'\n\n'

for node_path in $NODES_PATH/*
do
  NODE_DIR=$(basename $node_path)
  if [ -d $node_path ] && [ ${NODE_DIR:0:8} == "node_dir" ]
  then
    LOG_PATH=$(ls -t1 $node_path/sn_node.log* 2>/dev/null | head -n 1)
    if [ -n $LOG_PATH ]
    then
      ERROR_MSG=$(tac $LOG_PATH | sed -e '/ERROR/{N;N;q}' | tac)
      if [ -n "$ERROR_MSG" ]
      then
        ERROR_LOG+="-- ${LOG_PATH} --${TWO_NEW_LINES}${ERROR_MSG}${TWO_NEW_LINES}"
      fi
    fi
  fi
done
if [ -n "$ERROR_LOG" ]
  then
    pbincli send -t "$ERROR_LOG"
  else
    echo "No node logs found in error."
fi
